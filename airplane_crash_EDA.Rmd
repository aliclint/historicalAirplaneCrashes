---
title: "Airplane Crash EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("airplane_crash_functions.R")
library(tidyverse)
```

## Scrape and read file into data
```{r cars}
file = "airplaneCrashData.csv"
if(!TRUE %in% (list.files() == file)) { # Checks if file exists in local directory.
  source("airplane_crash_web_scrape.R")
}
airplane.crash <- read.csv(file,header=T,stringsAsFactors=FALSE)
```

```{r data-cleaning, echo=FALSE, include=FALSE}
# Processing date into month and year.
airplane.crash$date <- as.Date(airplane.crash$date, "%B %d, %Y")
airplane.crash$month <- format(as.Date(airplane.crash$date), "%m")
airplane.crash$year <- format(as.Date(airplane.crash$date), "%Y")

# 24H time of the crash. 
airplane.crash$time <- as.numeric(airplane.crash$time)

# Determines total number of people on the plane.
aboard <- gsub("\\D+"," ",airplane.crash$aboard) # extract 1st integer to get absolute counts
aboard.split <- strsplit(aboard," ")
airplane.crash$aboard <- as.numeric(sapply(aboard.split, "[[", 1)) # extract 1st entry of sublist

# Determines fatalities onboard the plane.
fatalities <- gsub("\\D+"," ",airplane.crash$fatalities) # extract 1st integer to get absolute counts
fatalities.split <- strsplit(fatalities," ")
airplane.crash$fatalities <- as.numeric(sapply(fatalities.split, "[[", 1)) # extract 1st entry of sublist

# Fatalaties on the ground.
airplane.crash$ground <- as.numeric(airplane.crash$ground)

# Proportion of passengers dead aboard and on the ground.
airplane.crash$dead.prop <- (airplane.crash$fatalities + airplane.crash$ground) / airplane.crash$aboard

# Process the route feature.
route.split <- strsplit(airplane.crash$route," - ")
index.shift<- sapply(route.split,length) # find indices of each sublist when unlisted
route.split <- unlist(route.split) # flatten for cumsum algorithm to work
names(index.shift) <- c()

# Determines the country of origin if applicable.
index_origin <- cumsum(index.shift) - (index.shift - 1)
origin.raw <- route.split[index_origin]
origin <- as.character((origin.raw))
names(origin) <- c()
airplane.crash$origin <- origin

# Determines the country of destination if applicable.
index.destination <- cumsum(index.shift)
destination.raw <- route.split[index.destination]
destination <- as.character(ExtractCountry(destination.raw))
names(destination) <- c()
airplane.crash$destination <- destination

# Determines if this is an international or domestic flight if applicable.
airplane.crash$international <- destination == location 

# Determines the country of the crash.
location <- as.character(ExtractCountry(airplane.crash$location))
names(location) <- c()
length(unique(location)) #155 countries which are less than 195 countries
airplane.crash$location <- location

# Determines whether the plane is civil or military.
uses <- unlist(lapply(airplane.crash$operator,ExtractAirplaneUses))
airplane.crash$uses <- uses

# Determines whether the plane crash was known or unknown.
known <- unlist(lapply(airplane.crash$summary,ExtractCrashCauseKnown))
airplane.crash$known <- known
```

```{r date-time-plot, echo=FALSE}
airplane.crash %>% group_by(month,year) %>% count() %>% ggplot(aes(x=month,y=n)) + geom_boxplot()
```

```{r}

```
